<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.online.taxi.mapper.OrderMapper">
    <resultMap id="BaseResultMap" type="com.online.taxi.entity.Order">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="order_number" property="orderNumber" jdbcType="VARCHAR"/>
        <result column="passenger_info_id" property="passengerInfoId" jdbcType="INTEGER"/>
        <result column="passenger_phone" property="passengerPhone" jdbcType="VARCHAR"/>
        <result column="device_code" property="deviceCode" jdbcType="VARCHAR"/>
        <result column="driver_id" property="driverId" jdbcType="INTEGER"/>
        <result column="driver_status" property="driverStatus" jdbcType="INTEGER"/>
        <result column="driver_phone" property="driverPhone" jdbcType="VARCHAR"/>
        <result column="car_id" property="carId" jdbcType="INTEGER"/>
        <result column="plate_number" property="plateNumber" jdbcType="VARCHAR"/>
        <result column="user_longitude" property="userLongitude" jdbcType="VARCHAR"/>
        <result column="user_latitude" property="userLatitude" jdbcType="VARCHAR"/>
        <result column="start_longitude" property="startLongitude" jdbcType="VARCHAR"/>
        <result column="start_latitude" property="startLatitude" jdbcType="VARCHAR"/>
        <result column="start_address" property="startAddress" jdbcType="VARCHAR"/>
        <result column="end_address" property="endAddress" jdbcType="VARCHAR"/>
        <result column="start_time" property="startTime" jdbcType="TIMESTAMP"/>
        <result column="order_start_time" property="orderStartTime" jdbcType="TIMESTAMP"/>
        <result column="end_longitude" property="endLongitude" jdbcType="VARCHAR"/>
        <result column="end_latitude" property="endLatitude" jdbcType="VARCHAR"/>
        <result column="driver_grab_time" property="driverGrabTime" jdbcType="TIMESTAMP"/>
        <result column="driver_start_time" property="driverStartTime" jdbcType="TIMESTAMP"/>
        <result column="driver_arrived_time" property="driverArrivedTime" jdbcType="TIMESTAMP"/>
        <result column="pick_up_passenger_longitude" property="pickUpPassengerLongitude" jdbcType="VARCHAR"/>
        <result column="pick_up_passenger_latitude" property="pickUpPassengerLatitude" jdbcType="VARCHAR"/>
        <result column="pick_up_passenger_address" property="pickUpPassengerAddress" jdbcType="VARCHAR"/>
        <result column="receive_passenger_time" property="receivePassengerTime" jdbcType="TIMESTAMP"/>
        <result column="receive_passenger_longitude" property="receivePassengerLongitude" jdbcType="VARCHAR"/>
        <result column="receive_passenger_latitude" property="receivePassengerLatitude" jdbcType="VARCHAR"/>
        <result column="passenger_getoff_time" property="passengerGetoffTime" jdbcType="TIMESTAMP"/>
        <result column="passenger_getoff_longitude" property="passengerGetoffLongitude" jdbcType="VARCHAR"/>
        <result column="passenger_getoff_latitude" property="passengerGetoffLatitude" jdbcType="VARCHAR"/>
        <result column="other_name" property="otherName" jdbcType="VARCHAR"/>
        <result column="other_phone" property="otherPhone" jdbcType="VARCHAR"/>
        <result column="order_type" property="orderType" jdbcType="INTEGER"/>
        <result column="service_type" property="serviceType" jdbcType="INTEGER"/>
        <result column="order_channel" property="orderChannel" jdbcType="INTEGER"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="transaction_id" property="transactionId" jdbcType="VARCHAR"/>
        <result column="mapping_id" property="mappingId" jdbcType="VARCHAR"/>
        <result column="mapping_number" property="mappingNumber" jdbcType="VARCHAR"/>
        <result column="merchant_id" property="merchantId" jdbcType="VARCHAR"/>
        <result column="is_evaluate" property="isEvaluate" jdbcType="INTEGER"/>
        <result column="invoice_type" property="invoiceType" jdbcType="INTEGER"/>
        <result column="is_annotate" property="isAnnotate" jdbcType="INTEGER"/>
        <result column="source" property="source" jdbcType="VARCHAR"/>
        <result column="use_coupon" property="useCoupon" jdbcType="INTEGER"/>
        <result column="cancel_order_type" property="cancelOrderType" jdbcType="INTEGER"/>
        <result column="pay_type" property="payType" jdbcType="INTEGER"/>
        <result column="is_paid" property="isPaid" jdbcType="INTEGER"/>
        <result column="is_cancel" property="isCancel" jdbcType="INTEGER"/>
        <result column="is_adjust" property="isAdjust" jdbcType="INTEGER"/>
        <result column="is_dissent" property="isDissent" jdbcType="INTEGER"/>
        <result column="is_manual" property="isManual" jdbcType="INTEGER"/>
        <result column="is_following" property="isFollowing" jdbcType="INTEGER"/>
        <result column="is_fake_success" property="isFakeSuccess" jdbcType="INTEGER"/>
        <result column="memo" property="memo" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="user_feature" property="userFeature" jdbcType="INTEGER"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        id, order_number, passenger_info_id, passenger_phone, device_code, driver_id, driver_status,
        driver_phone, car_id, plate_number, user_longitude, user_latitude, start_longitude,
        start_latitude, start_address, end_address, start_time, order_start_time, end_longitude,
        end_latitude, driver_grab_time, driver_start_time, driver_arrived_time, pick_up_passenger_longitude,
        pick_up_passenger_latitude, pick_up_passenger_address, receive_passenger_time, receive_passenger_longitude,
        receive_passenger_latitude, passenger_getoff_time, passenger_getoff_longitude, passenger_getoff_latitude,
        other_name, other_phone, order_type, service_type, order_channel, status, transaction_id,
        mapping_id, mapping_number, merchant_id, is_evaluate, invoice_type, is_annotate,
        source, use_coupon, cancel_order_type, pay_type, is_paid, is_cancel, is_adjust, is_dissent,
        is_manual, is_following, is_fake_success, memo, create_time, update_time, user_feature
    </sql>
    <select id="countByBetweenTime" resultType="java.lang.Integer">
        select
        count(*)
        from tbl_order
        where driver_id = #{driverId} and order_start_time between #{startTime} and #{endTime} and status
        <![CDATA[ > ]]> 1 and status <![CDATA[ < ]]> 7
    </select>

    <select id="countOrderByParam" resultType="java.lang.Integer">
        SELECT
        count(*)
        FROM
        (
        SELECT
        *
        FROM
        (
        SELECT
        date_add(
        t1.order_start_time,
        INTERVAL - t3.car_service_before_interval MINUTE
        ) AS time1,
        date_add(
        t1.order_start_time,
        INTERVAL t3.car_service_after_interval MINUTE
        ) AS time2
        FROM
        `tbl_order` AS t1
        LEFT JOIN tbl_order_rule_price AS t2 ON t1.id = t2.order_id
        AND t2.category = 0
        LEFT JOIN tbl_car_dispatch_distribute_interval_set AS t3 ON t3.city_code = t2.city_code
        AND t3.service_type_id = t2.service_type_id
        WHERE
        t1.driver_id = #{driverId}
        and t1.status <![CDATA[ > ]]> 1
        and t1.status <![CDATA[ < ]]> 7
        ) t where (#{startTime} <![CDATA[ >= ]]> t.time1 and #{startTime} <![CDATA[ < ]]> t.time2) or (#{endTime}
        <![CDATA[ > ]]> t.time1 and #{endTime} <![CDATA[ <= ]]> t.time2) or (#{startTime} <![CDATA[ <= ]]> t.time1 and
        #{endTime} <![CDATA[ >= ]]> t.time2)
        ) tt;

    </select>


    <select id="countDriverByParam" resultType="java.lang.Integer">
        SELECT
        count(*)
        FROM
        (
        SELECT
        *
        FROM
        (
        SELECT
        date_add(
        t1.order_start_time,
        INTERVAL - t3.car_service_before_interval MINUTE
        ) AS time1,
        date_add(
        t1.order_start_time,
        INTERVAL t3.car_service_after_interval MINUTE
        ) AS time2
        FROM
        `tbl_order` AS t1
        INNER JOIN tbl_order_rule_price AS t2 ON t1.id = t2.order_id
        AND t2.category = 0
        LEFT JOIN tbl_car_dispatch_distribute_interval_set AS t3 ON t3.city_code = t2.city_code
        AND t3.service_type_id = t2.service_type_id
        WHERE
        t1.driver_id = #{driverId}
        and t1.status <![CDATA[ > ]]> 1
        and t1.status <![CDATA[ < ]]> 7
        ) t where (#{startTime} <![CDATA[ <= ]]> t.time2 or #{endTime} <![CDATA[ >= ]]> t.time2)
        ) tt;

    </select>


    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        from tbl_order
        where id = #{id,jdbcType=INTEGER}
    </select>
</mapper>
