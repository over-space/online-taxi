<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.online.taxi.mapper.DynamicDiscountRuleMapper">
    <resultMap id="BaseResultMap" type="com.online.taxi.entity.DynamicDiscountRule">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="service_type" property="serviceType" jdbcType="VARCHAR"/>
        <result column="car_level" property="carLevel" jdbcType="VARCHAR"/>
        <result column="time_set" property="timeSet" jdbcType="VARCHAR"/>
        <result column="date_type" property="dateType" jdbcType="INTEGER"/>
        <result column="week_set" property="weekSet" jdbcType="VARCHAR"/>
        <result column="special_date_set" property="specialDateSet" jdbcType="VARCHAR"/>
        <result column="discount_max_price" property="discountMaxPrice" jdbcType="DOUBLE"/>
        <result column="valid_start_time" property="validStartTime" jdbcType="TIMESTAMP"/>
        <result column="valid_end_time" property="validEndTime" jdbcType="TIMESTAMP"/>
        <result column="is_unuse" property="isUnuse" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        id, service_type, car_level, time_set, date_type, week_set, special_date_set, discount_max_price,
        valid_start_time, valid_end_time, is_unuse, create_time, update_time
    </sql>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        from tbl_dynamic_discount_rule
        where id = #{id,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from tbl_dynamic_discount_rule
        where id = #{id,jdbcType=INTEGER}
    </delete>
    <insert id="insert" parameterType="com.online.taxi.entity.DynamicDiscountRule" useGeneratedKeys="true"
            keyProperty="id">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into tbl_dynamic_discount_rule (service_type, car_level, time_set,
        date_type, week_set, special_date_set,
        discount_max_price, valid_start_time, valid_end_time,
        is_unuse, create_time, update_time
        )
        values (#{serviceType,jdbcType=VARCHAR}, #{carLevel,jdbcType=VARCHAR}, #{timeSet,jdbcType=VARCHAR},
        #{dateType,jdbcType=INTEGER}, #{weekSet,jdbcType=VARCHAR}, #{specialDateSet,jdbcType=VARCHAR},
        #{discountMaxPrice,jdbcType=DOUBLE}, #{validStartTime,jdbcType=TIMESTAMP}, #{validEndTime,jdbcType=TIMESTAMP},
        #{isUnuse,jdbcType=INTEGER}, #{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP}
        )
    </insert>
    <insert id="insertSelective" parameterType="com.online.taxi.entity.DynamicDiscountRule"
            useGeneratedKeys="true" keyProperty="id">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into tbl_dynamic_discount_rule
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="serviceType != null">
                service_type,
            </if>
            <if test="carLevel != null">
                car_level,
            </if>
            <if test="timeSet != null">
                time_set,
            </if>
            <if test="dateType != null">
                date_type,
            </if>
            <if test="weekSet != null">
                week_set,
            </if>
            <if test="specialDateSet != null">
                special_date_set,
            </if>
            <if test="discountMaxPrice != null">
                discount_max_price,
            </if>
            <if test="validStartTime != null">
                valid_start_time,
            </if>
            <if test="validEndTime != null">
                valid_end_time,
            </if>
            <if test="isUnuse != null">
                is_unuse,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="serviceType != null">
                #{serviceType,jdbcType=VARCHAR},
            </if>
            <if test="carLevel != null">
                #{carLevel,jdbcType=VARCHAR},
            </if>
            <if test="timeSet != null">
                #{timeSet,jdbcType=VARCHAR},
            </if>
            <if test="dateType != null">
                #{dateType,jdbcType=INTEGER},
            </if>
            <if test="weekSet != null">
                #{weekSet,jdbcType=VARCHAR},
            </if>
            <if test="specialDateSet != null">
                #{specialDateSet,jdbcType=VARCHAR},
            </if>
            <if test="discountMaxPrice != null">
                #{discountMaxPrice,jdbcType=DOUBLE},
            </if>
            <if test="validStartTime != null">
                #{validStartTime,jdbcType=TIMESTAMP},
            </if>
            <if test="validEndTime != null">
                #{validEndTime,jdbcType=TIMESTAMP},
            </if>
            <if test="isUnuse != null">
                #{isUnuse,jdbcType=INTEGER},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.online.taxi.entity.DynamicDiscountRule">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update tbl_dynamic_discount_rule
        <set>
            <if test="serviceType != null">
                service_type = #{serviceType,jdbcType=VARCHAR},
            </if>
            <if test="carLevel != null">
                car_level = #{carLevel,jdbcType=VARCHAR},
            </if>
            <if test="timeSet != null">
                time_set = #{timeSet,jdbcType=VARCHAR},
            </if>
            <if test="dateType != null">
                date_type = #{dateType,jdbcType=INTEGER},
            </if>
            <if test="weekSet != null">
                week_set = #{weekSet,jdbcType=VARCHAR},
            </if>
            <if test="specialDateSet != null">
                special_date_set = #{specialDateSet,jdbcType=VARCHAR},
            </if>
            <if test="discountMaxPrice != null">
                discount_max_price = #{discountMaxPrice,jdbcType=DOUBLE},
            </if>
            <if test="validStartTime != null">
                valid_start_time = #{validStartTime,jdbcType=TIMESTAMP},
            </if>
            <if test="validEndTime != null">
                valid_end_time = #{validEndTime,jdbcType=TIMESTAMP},
            </if>
            <if test="isUnuse != null">
                is_unuse = #{isUnuse,jdbcType=INTEGER},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.online.taxi.entity.DynamicDiscountRule">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update tbl_dynamic_discount_rule
        set service_type = #{serviceType,jdbcType=VARCHAR},
        car_level = #{carLevel,jdbcType=VARCHAR},
        time_set = #{timeSet,jdbcType=VARCHAR},
        date_type = #{dateType,jdbcType=INTEGER},
        week_set = #{weekSet,jdbcType=VARCHAR},
        special_date_set = #{specialDateSet,jdbcType=VARCHAR},
        discount_max_price = #{discountMaxPrice,jdbcType=DOUBLE},
        valid_start_time = #{validStartTime,jdbcType=TIMESTAMP},
        valid_end_time = #{validEndTime,jdbcType=TIMESTAMP},
        is_unuse = #{isUnuse,jdbcType=INTEGER},
        create_time = #{createTime,jdbcType=TIMESTAMP},
        update_time = #{updateTime,jdbcType=TIMESTAMP}
        where id = #{id,jdbcType=INTEGER}
    </update>
    <select id="findDiscountByCondition" resultType="com.online.taxi.dto.valuation.discount.DiscountPrice">
        SELECT
            *
        FROM
            (
                (
                    SELECT
                        t1.discount_max_price,
                        t3.discount,
                        t1.date_type
                    FROM
                        tbl_dynamic_discount_rule AS t1
                            INNER JOIN tbl_dynamic_discount_city AS t2 ON t1.id = t2.dynamic_discount_rule_id
                            LEFT JOIN tbl_dynamic_discount_info AS t3 ON t1.id = t3.dynamic_discount_rule_id
                    WHERE
                        t1.is_unuse = 0
                      AND NOW() BETWEEN t1.valid_start_time AND t1.valid_end_time
                      AND t3.is_delete = 0
                      AND t1.date_type = 2
                      AND t2.city_code = #{cityCode}
                      AND t3.km <![CDATA[<=]]> #{totalDistance}
                      AND FIND_IN_SET(#{serviceTypeId}, t1.service_type)
                      AND FIND_IN_SET(#{carLevelId}, t1.car_level)
                      AND FIND_IN_SET(#{startDate}, t1.special_date_set)
                      AND FIND_IN_SET(#{startHour}, t1.time_set)
                    ORDER BY
                        t3.km DESC
                        LIMIT 1
                )
                UNION ALL
                (
                    SELECT
                        t1.discount_max_price,
                        t3.discount,
                        t1.date_type
                    FROM
                        tbl_dynamic_discount_rule AS t1
                            INNER JOIN tbl_dynamic_discount_city AS t2 ON t1.id = t2.dynamic_discount_rule_id
                            LEFT JOIN tbl_dynamic_discount_info AS t3 ON t1.id = t3.dynamic_discount_rule_id
                    WHERE
                        t1.is_unuse = 0
                      AND NOW() BETWEEN t1.valid_start_time
                        AND t1.valid_end_time
                      AND t3.is_delete = 0
                      AND t1.date_type = 1
                      AND t2.city_code = #{cityCode}
                      AND t3.km <![CDATA[<=]]> #{totalDistance}
                      AND FIND_IN_SET(#{serviceTypeId}, t1.service_type)
                      AND FIND_IN_SET(#{carLevelId}, t1.car_level)
                      AND FIND_IN_SET(#{startWeekDay}, t1.week_set)
                      AND FIND_IN_SET(#{startHour}, t1.time_set)
                    ORDER BY
                        t3.km DESC
                        LIMIT 1
                )
            ) t
        ORDER BY
            t.date_type DESC
            LIMIT 1
    </select>
</mapper>